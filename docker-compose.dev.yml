# VOICEVOX 拡張辞書システム - 開発用 Docker Compose
# 使い方: docker compose -f docker-compose.dev.yml up -d

services:
  # VOICEVOX Engine（公式 Docker イメージ）
  voicevox-engine:
    image: voicevox/voicevox_engine:cpu-latest
    container_name: voicevox-engine
    platform: linux/amd64
    ports:
      - "127.0.0.1:50021:50021"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:50021/version"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 拡張辞書サーバー（開発モード）
  extension-server:
    build:
      context: ./server
      dockerfile: Dockerfile
    container_name: voicevox-extension
    ports:
      - "127.0.0.1:8000:8000"
    environment:
      - VOICEVOX_ENGINE_URL=http://voicevox-engine:50021
      - DATA_DIR=/app/data
    volumes:
      - ./data:/app/data
      - ./server/app:/app/app  # ホットリロード用
    depends_on:
      voicevox-engine:
        condition: service_healthy
    restart: unless-stopped

  # VOICEVOX Editor（ブラウザ版 - 開発時のみ）
  # 注意: voicevox-editor リポジトリが ../voicevox-editor にある前提
  editor:
    build:
      context: ../voicevox-editor
      dockerfile: Dockerfile.browser
    container_name: voicevox-editor-web
    ports:
      - "127.0.0.1:3000:80"
    depends_on:
      - extension-server
      - voicevox-engine
    restart: unless-stopped
    environment:
      - EXTENSION_SERVER_URL=http://extension-server:8000
    profiles:
      - browser  # docker compose --profile browser up で起動
